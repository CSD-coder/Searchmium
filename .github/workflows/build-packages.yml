name: Build Package
on:
  push:
    branches: [ main ]  # Automated builds on commits to main
  workflow_dispatch  # Manual trigger

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true  # Cancel outdated runs

permissions:
  contents: read
  actions: write  # For uploading artifacts

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            cmd: npm run buildDebian
            artifact: linux-deb-package
            path: dist/app/*.deb
          - os: ubuntu-latest
            cmd: npm run buildRedhat
            artifact: linux-rpm-package
            path: dist/app/*.rpm
          - os: ubuntu-latest
            cmd: npm run buildAppImage
            artifact: linux-appimage-package
            path: dist/app/*.AppImage
          - os: windows-latest
            cmd: npm run buildWindows
            artifact: windows-package
            path: |
              dist/app/*.zip
              dist/app/*.exe
          - os: macos-15
            env:
              SDKROOT: /Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX.sdk
            cmd: npm run buildMacIntel
            artifact: darwin-x86-package
            path: dist/app/*.zip
          - os: macos-15
            env:
              SDKROOT: /Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX.sdk
            cmd: npm run buildMacArm
            artifact: darwin-arm-package
            path: dist/app/*.zip
    env:
      SDKROOT: ${{ matrix.env.SDKROOT }}
    steps:
    - name: Checkout code
      uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332  # Pinned to v4.1.7 for security
    - name: Setup Node.js
      uses: actions/setup-node@60edb5dd545a775178f52524783378180af0d1f8  # Pinned to v4.0.2
      with:
        node-version: 20  # LTS for Electron compatibility
        cache: npm  # Cache npm deps for faster builds
    - name: Install dependencies
      run: npm ci  # Use ci for faster, reproducible installs
    - name: Build package
      run: ${{ matrix.cmd }}
    - name: Upload package
      uses: actions/upload-artifact@65c4c4a1ddee5b72f698fdd19549f0f0fb45cf08  # Pinned to v4.6.0
      with:
        name: ${{ matrix.artifact }}
        path: ${{ matrix.path }}
    - name: Upload build logs on failure
      if: failure()
      uses: actions/upload-artifact@65c4c4a1ddee5b72f698fdd19549f0f0fb45cf08
      with:
        name: build-logs-${{ matrix.os }}
        path: |
          *.log
          dist/**/*.log  # Capture any logs from build scripts
